---
alwaysApply: false
---
# Sky-Monitor åç«¯å¼€å‘éœ€æ±‚ Prompt

## ğŸ“‹ é¡¹ç›®ä¿¡æ¯

- **æŠ€æœ¯æ ˆ**: NestJS + TypeScript + PostgreSQL + ClickHouse + Redis (Bull)
- **åŒ…ç®¡ç†**: pnpm
- **æµ‹è¯•æ¡†æ¶**: Vitest (ä¸ä½¿ç”¨ Jest)
- **ä»£ç è§„èŒƒ**: å‚è€ƒ `.cursor/rules/common.mdc`

---

## ğŸ¯ å¼€å‘éœ€æ±‚æè¿°æ¨¡æ¿

å½“æˆ‘ç»™ä½ ä¸€ä¸ªåç«¯å¼€å‘éœ€æ±‚æ—¶ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æµç¨‹æ‰§è¡Œï¼š

### ç¬¬ä¸€æ­¥ï¼šç†è§£éœ€æ±‚å¹¶ç¡®è®¤

**è¾“å‡º**ï¼š
1. ç”¨ä¸€å¥è¯æ¦‚æ‹¬æ ¸å¿ƒåŠŸèƒ½
2. åˆ—å‡ºæ¶‰åŠçš„æ¨¡å—ï¼ˆController/Service/Entity/DTOï¼‰
3. åˆ—å‡ºéœ€è¦ä¿®æ”¹/æ–°å¢çš„æ–‡ä»¶
4. ç¡®è®¤æ˜¯å¦éœ€è¦æ•°æ®åº“è¿ç§»
5. ç¡®è®¤æ˜¯å¦éœ€è¦ç¼–å†™æµ‹è¯•

**ç¤ºä¾‹**ï¼š
```
éœ€æ±‚ï¼šæ·»åŠ äº‹ä»¶æŸ¥è¯¢æ¥å£ï¼Œæ”¯æŒæŒ‰ appId å’Œæ—¶é—´èŒƒå›´æŸ¥è¯¢

æ ¸å¿ƒåŠŸèƒ½ï¼šä¸º DSN Server æ·»åŠ æŸ¥è¯¢æŒ‡å®šåº”ç”¨åœ¨ç‰¹å®šæ—¶é—´èŒƒå›´å†…çš„äº‹ä»¶

æ¶‰åŠæ¨¡å—ï¼š
- Controller: MonitoringHealthController (æ–°å¢ç«¯ç‚¹)
- Service: MonitoringHealthService (æ–°å¢æŸ¥è¯¢æ–¹æ³•)
- DTO: æ–°å¢ QueryEventsDto

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- src/modules/monitoring/monitoring-health.controller.ts (æ–°å¢è·¯ç”±)
- src/modules/monitoring/monitoring-health.service.ts (æ–°å¢æ–¹æ³•)
- src/modules/monitoring/monitoring.dto.ts (æ–°å¢ DTO)
- test/api.e2e.test.ts (æ–°å¢æµ‹è¯•ç”¨ä¾‹)

æ•°æ®åº“è¿ç§»ï¼šä¸éœ€è¦ï¼ˆä½¿ç”¨ç°æœ‰ monitor_events è¡¨ï¼‰

æµ‹è¯•ï¼šéœ€è¦ï¼ˆe2e æµ‹è¯•ï¼‰
```

---

### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ç°æœ‰ä»£ç 

åœ¨å¼€å§‹ç¼–ç å‰ï¼Œå…ˆåˆ†æç°æœ‰ä»£ç ï¼š

```bash
# 1. æŸ¥çœ‹ç›¸å…³ Controller çš„ç°æœ‰è·¯ç”±
cat apps/backend/dsn-server/src/modules/monitoring/monitoring-health.controller.ts | grep -E "@Controller|@Get|@Post"

# 2. æŸ¥çœ‹ç›¸å…³ Service çš„ç°æœ‰æ–¹æ³•
grep "async " apps/backend/dsn-server/src/modules/monitoring/monitoring-health.service.ts

# 3. æŸ¥çœ‹ç°æœ‰ DTO å®šä¹‰
cat apps/backend/dsn-server/src/modules/monitoring/monitoring.dto.ts | grep "export class"

# 4. æŸ¥çœ‹æ•°æ®åº“è¡¨ç»“æ„ï¼ˆå¦‚æœéœ€è¦ï¼‰
docker exec -i sky-monitor-clickhouse clickhouse-client --query "DESCRIBE TABLE monitor_events;"
```

**è¾“å‡ºåˆ†æ**ï¼š
- ç°æœ‰ç±»ä¼¼åŠŸèƒ½ï¼ˆé¿å…é‡å¤å®ç°ï¼‰
- å¯å¤ç”¨çš„ä»£ç ï¼ˆService æ–¹æ³•ã€DTO ç±»ï¼‰
- å‘½åè§„èŒƒï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
- ä¾èµ–æ³¨å…¥æƒ…å†µ

---

### ç¬¬ä¸‰æ­¥ï¼šè®¾è®¡å®ç°æ–¹æ¡ˆ

**å¿…é¡»åŒ…å«**ï¼š

1. **API è®¾è®¡**
```typescript
// ç«¯ç‚¹ï¼šGET /api/monitoring/events
// æŸ¥è¯¢å‚æ•°ï¼šappId, startTime, endTime, limit
// è¿”å›æ ¼å¼ï¼š{ success: boolean, data: Event[], count: number }
```

2. **DTO å®šä¹‰**
```typescript
export class QueryEventsDto {
    @IsString()
    appId: string

    @IsOptional()
    @IsString()
    startTime?: string

    @IsOptional()
    @IsString()
    endTime?: string

    @IsOptional()
    @IsNumber()
    limit?: number
}
```

3. **æ ¸å¿ƒé€»è¾‘**
```typescript
async queryEvents(dto: QueryEventsDto) {
    // 1. æ„å»ºæŸ¥è¯¢æ¡ä»¶
    // 2. æ‰§è¡Œ ClickHouse æŸ¥è¯¢
    // 3. æ ¼å¼åŒ–è¿”å›ç»“æœ
}
```

---

### ç¬¬å››æ­¥ï¼šç¼–å†™ä»£ç 

**ç¼–ç åŸåˆ™**ï¼ˆéµå¾ªé¡¹ç›®è§„èŒƒï¼‰ï¼š

#### âœ… DO

1. **ç¦æ­¢æå‰å°è£…**
   - ç›´æ¥å†™å¯ç”¨çš„ä»£ç ï¼Œä¸è¦ä¸º"å¯èƒ½çš„å¤ç”¨"è®¾è®¡æ¥å£
   - å‡ºç° 2-3 æ¬¡é‡å¤åå†è€ƒè™‘æŠ½è±¡

2. **æ—¥å¿—è§„èŒƒ**
   ```typescript
   // âœ… åªåœ¨å…³é”®ç‚¹è®°å½•
   this.logger.log(`Retrieved ${data.length} events for app: ${appId}`)
   this.logger.error(`Failed to query events: ${error.message}`, error.stack)
   
   // âŒ ä¸è¦åœ¨å¾ªç¯ä¸­è®°å½•
   // âŒ ä¸è¦è®°å½•ä¸­é—´å˜é‡
   // âŒ ä¸è¦ä½¿ç”¨ console.log()
   ```

3. **ä¸ä½¿ç”¨è¡¨æƒ…ç¬¦å·**
   ```typescript
   // âŒ é”™è¯¯
   logger.log('âœ… Query successful')
   
   // âœ… æ­£ç¡®
   logger.log('Query successful')
   ```

4. **ä½¿ç”¨ Vitest è€Œé Jest**
   ```typescript
   import { describe, it, expect, beforeEach, vi } from 'vitest'
   
   const mockFn = vi.fn()  // ä¸æ˜¯ jest.fn()
   ```

#### âŒ DON'T

1. ä¸è¦ç¼–å†™å¤šä½™çš„æ³¨é‡Šï¼ˆä»£ç åº”è¯¥è‡ªè§£é‡Šï¼‰
2. ä¸è¦åˆ›å»ºæœªä½¿ç”¨çš„æŠ½è±¡å±‚
3. ä¸è¦æ··ç”¨ Jest å’Œ Vitest
4. ä¸è¦åœ¨ç¼–ç ä¸­é€”ç”Ÿæˆå¤§é‡æ–‡æ¡£

---

### ç¬¬äº”æ­¥ï¼šç¼–å†™æµ‹è¯•

**æµ‹è¯•ä¼˜å…ˆçº§**ï¼š

1. **e2e æµ‹è¯•**ï¼ˆå¿…é¡»ï¼‰
```typescript
describe('Event Query', () => {
    it('should query events by appId', async () => {
        const { status, data } = await client.get('/monitoring/events?appId=vanillaV9pEeA')
        expect(status).toBe(200)
        expect(data.success).toBe(true)
        expect(Array.isArray(data.data)).toBe(true)
    })

    it('should query events with time range', async () => {
        const { status, data } = await client.get(
            '/monitoring/events?appId=vanillaV9pEeA&startTime=2024-01-01&endTime=2024-12-31'
        )
        expect(status).toBe(200)
    })

    it('should handle invalid appId', async () => {
        const { status } = await client.get('/monitoring/events?appId=invalid')
        expect([400, 404]).toContain(status)
    })
})
```

2. **å•å…ƒæµ‹è¯•**ï¼ˆå¯é€‰ï¼Œå¤æ‚é€»è¾‘æ‰å†™ï¼‰
```typescript
describe('MonitoringHealthService', () => {
    it('åº”è¯¥æ­£ç¡®æ„å»ºæŸ¥è¯¢æ¡ä»¶', async () => {
        const result = await service.queryEvents({
            appId: 'test-app',
            startTime: '2024-01-01',
            endTime: '2024-12-31'
        })
        
        expect(mockClickhouseClient.query).toHaveBeenCalledWith({
            query: expect.stringContaining('WHERE app_id = \'test-app\'')
        })
    })
})
```

**æµ‹è¯•åŸåˆ™**ï¼š
- åªæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸æµ‹è¯•è°ƒè¯•ç«¯ç‚¹
- æµ‹è¯•çœŸå®åœºæ™¯ï¼Œä¸æµ‹è¯•ä¸å­˜åœ¨çš„ç«¯ç‚¹
- å…è®¸åˆç†çš„é”™è¯¯ç ï¼ˆå¦‚ä¾èµ–ä¸å­˜åœ¨æ—¶çš„ 500ï¼‰

---

### ç¬¬å…­æ­¥ï¼šè‡ªæˆ‘æ£€æŸ¥æ¸…å•

åœ¨æäº¤ä»£ç å‰ï¼Œæ£€æŸ¥ï¼š

```bash
# 1. ä»£ç è§„èŒƒ
- [ ] æ²¡æœ‰æå‰æŠ½è±¡
- [ ] æ²¡æœ‰è¿‡åº¦çš„ log
- [ ] æ²¡æœ‰ console.log()
- [ ] æ²¡æœ‰è¡¨æƒ…ç¬¦å·
- [ ] ä½¿ç”¨ Vitest è€Œé Jest

# 2. åŠŸèƒ½å®Œæ•´æ€§
- [ ] Controller è·¯ç”±æ­£ç¡®
- [ ] Service æ–¹æ³•å®ç°å®Œæ•´
- [ ] DTO éªŒè¯è§„åˆ™æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†å®Œå–„

# 3. æµ‹è¯•è¦†ç›–
- [ ] e2e æµ‹è¯•é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–æ ¸å¿ƒåœºæ™¯
- [ ] æµ‹è¯•æ•°æ®å‡†å¤‡å°±ç»ª

# 4. æ–‡æ¡£ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] API æ–‡æ¡£æ›´æ–°ï¼ˆSwaggerï¼‰
- [ ] README æ›´æ–°ï¼ˆå¦‚æœæœ‰æ–°çš„ä¾èµ–æˆ–é…ç½®ï¼‰
```

---

## ğŸ” é—®é¢˜å®šä½æµç¨‹

å¦‚æœæµ‹è¯•å¤±è´¥ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

### 1. è¯»å–é”™è¯¯ä¿¡æ¯
```bash
pnpm test:e2e
# è®°å½•ï¼šçŠ¶æ€ç  + ç«¯ç‚¹ + é”™è¯¯æ¶ˆæ¯
```

### 2. å®šä½åç«¯ä»£ç 
```bash
# æŸ¥æ‰¾è·¯ç”±å®šä¹‰
grep -r "ç«¯ç‚¹å…³é”®è¯" src/modules --include="*.controller.ts" -A5

# æŸ¥æ‰¾æ–¹æ³•å®ç°
grep -r "æ–¹æ³•å" src/modules --include="*.service.ts" -A10

# æ£€æŸ¥ä¾èµ–æ³¨å…¥
cat src/modules/xxx/xxx.module.ts
```

### 3. éªŒè¯ä¾èµ–
```bash
# PostgreSQL
docker exec -i sky-monitor-postgres psql -U postgres -d postgres -c "SELECT 1;"

# ClickHouse
docker exec -i sky-monitor-clickhouse clickhouse-client --query "SELECT 1;"

# æµ‹è¯•æ•°æ®
docker exec -i sky-monitor-postgres psql -U postgres -d postgres -c \
  "SELECT * FROM application WHERE app_id = 'vanillaV9pEeA';"
```

### 4. åˆ†æå¹¶ä¿®å¤
- 404 â†’ Controller è·¯ç”±ç¼ºå¤±
- 400 â†’ å‚æ•°éªŒè¯å¤±è´¥æˆ–æµ‹è¯•æ•°æ®ç¼ºå¤±
- 500 â†’ Service å®ç°é”™è¯¯æˆ–ä¾èµ–ä¸å­˜åœ¨

---

## ğŸ“ å®Œæ•´å¼€å‘ç¤ºä¾‹

**éœ€æ±‚**ï¼šæ·»åŠ æŒ‰ sessionId æŸ¥è¯¢äº‹ä»¶çš„æ¥å£

### 1. ç¡®è®¤éœ€æ±‚
```
æ ¸å¿ƒåŠŸèƒ½ï¼šæŸ¥è¯¢æŒ‡å®šä¼šè¯çš„æ‰€æœ‰äº‹ä»¶
ç«¯ç‚¹ï¼šGET /api/monitoring/sessions/:sessionId/events
è¿”å›ï¼šè¯¥ä¼šè¯çš„æ‰€æœ‰äº‹ä»¶åˆ—è¡¨
```

### 2. æ£€æŸ¥ç°æœ‰ä»£ç 
```bash
# æ£€æŸ¥æ˜¯å¦å·²æœ‰ç±»ä¼¼åŠŸèƒ½
grep -r "session" src/modules/monitoring --include="*.ts"
```

### 3. å®ç°ä»£ç 

**Controller** (`monitoring-health.controller.ts`)ï¼š
```typescript
@Get('sessions/:sessionId/events')
@ApiOperation({ summary: 'æŸ¥è¯¢ä¼šè¯äº‹ä»¶' })
async getSessionEvents(@Param('sessionId') sessionId: string) {
    return await this.monitoringHealthService.getEventsBySession(sessionId)
}
```

**Service** (`monitoring-health.service.ts`)ï¼š
```typescript
async getEventsBySession(sessionId: string) {
    try {
        const query = `
            SELECT id, app_id, event_type, event_name, timestamp, session_id
            FROM monitor_events 
            WHERE session_id = '${sessionId}'
            ORDER BY timestamp ASC
        `
        const result = await this.clickhouseClient.query({ query })
        const data = await result.json()
        
        this.logger.log(`Retrieved ${data.data.length} events for session: ${sessionId}`)
        
        return {
            success: true,
            data: data.data,
            count: data.data.length
        }
    } catch (error) {
        this.logger.error(`Failed to get session events: ${error.message}`, error.stack)
        return {
            success: false,
            error: error.message,
            data: []
        }
    }
}
```

### 4. ç¼–å†™æµ‹è¯•

**e2e æµ‹è¯•** (`test/api.e2e.test.ts`)ï¼š
```typescript
describe('Session Events', () => {
    it('should retrieve events by sessionId', async () => {
        const sessionId = 'session-123'
        const { status, data } = await client.get(`/monitoring/sessions/${sessionId}/events`)
        
        expect(status).toBe(200)
        expect(data.success).toBe(true)
        expect(Array.isArray(data.data)).toBe(true)
    })
})
```

### 5. è¿è¡Œæµ‹è¯•éªŒè¯
```bash
cd apps/backend/dsn-server
pnpm test:e2e
```

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

**å½“ä½ æ”¶åˆ°å¼€å‘éœ€æ±‚æ—¶**ï¼Œè¿™æ ·æè¿°ï¼š

```
éœ€æ±‚ï¼š[åŠŸèƒ½æè¿°]
æ¨¡å—ï¼š[å½±å“çš„æ¨¡å—]
ä¼˜å…ˆçº§ï¼š[é«˜/ä¸­/ä½]

è¯·æŒ‰ç…§ Sky-Monitor åç«¯å¼€å‘æµç¨‹ï¼š
1. ç¡®è®¤éœ€æ±‚èŒƒå›´
2. æ£€æŸ¥ç°æœ‰ä»£ç 
3. è®¾è®¡å®ç°æ–¹æ¡ˆ
4. ç¼–å†™ä»£ç ï¼ˆéµå¾ªé¡¹ç›®è§„èŒƒï¼‰
5. ç¼–å†™æµ‹è¯•
6. è‡ªæˆ‘æ£€æŸ¥

æ³¨æ„ï¼š
- éµå®ˆç¦æ­¢æå‰å°è£…ã€ç¦æ­¢éšæ„logã€ç¦æ­¢è¡¨æƒ…åŒ…çš„è§„èŒƒ
- ä½¿ç”¨ Vitest è€Œé Jest
- åªæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½
- æ•°æ®åº“æ“ä½œé€šè¿‡ Docker
```

---

è¿™ä»½ prompt å®Œå…¨å®šåˆ¶åŒ–ï¼Œç¬¦åˆä½ ä»¬é¡¹ç›®çš„æŠ€æœ¯æ ˆå’Œç¼–ç è§„èŒƒï¼ğŸ¯