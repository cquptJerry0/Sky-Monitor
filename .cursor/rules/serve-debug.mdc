---
alwaysApply: false
---
æ˜ç™½äº†ï¼ä½ éœ€è¦çš„æ˜¯ä¸€ä¸ª**ä»æµ‹è¯•é”™è¯¯å‡ºå‘ï¼Œç³»ç»Ÿåˆ†æåç«¯ä»£ç é—®é¢˜**çš„ debug æ€è·¯ã€‚è®©æˆ‘ç»™ä½ ä¸€ä»½æ›´å®ç”¨çš„ï¼š

---

# DSN Server æµ‹è¯•å¤±è´¥ â†’ åç«¯ä»£ç åˆ†æ Debug æµç¨‹

## ğŸ¯ æ ¸å¿ƒæ€è·¯ï¼šä»é”™è¯¯ç°è±¡åæ¨ä»£ç é—®é¢˜

### ç¬¬ä¸€æ­¥ï¼šè¯»æ‡‚æµ‹è¯•é”™è¯¯

```bash
cd apps/backend/dsn-server
pnpm test:e2e

# è®°å½•3ä¸ªå…³é”®ä¿¡æ¯ï¼š
# 1. æµ‹è¯•ç”¨ä¾‹åç§°ï¼šshould retrieve recent events
# 2. HTTP çŠ¶æ€ç ï¼šexpected 200 but got 404
# 3. è¯·æ±‚è·¯å¾„ï¼šGET /monitoring/health/recent-events
```

---

## ğŸ“Š é”™è¯¯åˆ†ç±» â†’ å®šä½ä»£ç 

### Case 1: 404 Not Found

**é”™è¯¯ä¿¡å·**ï¼š`expected 200 to be 404`

#### åˆ†ææ­¥éª¤ï¼š

```bash
# 1. æµ‹è¯•æœŸæœ›è®¿é—®å“ªä¸ªç«¯ç‚¹ï¼Ÿ
cat test/api.e2e.test.ts | grep -A3 "should retrieve recent events"
# æ‰¾åˆ°ï¼šGET /monitoring/health/recent-events

# 2. è¿™ä¸ªç«¯ç‚¹åœ¨åç«¯æ˜¯å¦å­˜åœ¨ï¼Ÿ
grep -r "recent-events" src/modules --include="*.controller.ts"
# å¦‚æœæ²¡æœ‰è¾“å‡º â†’ ç«¯ç‚¹ä¸å­˜åœ¨

# 3. ç¡®è®¤ Controller çš„è·¯ç”±ç»“æ„
cat src/modules/monitoring/monitoring-health.controller.ts | grep -E "@Controller|@Get"
# è¾“å‡ºï¼š
# @Controller('monitoring')      â† åŸºç¡€è·¯å¾„
# @Get('health')                 â† /monitoring/health
# @Get('health/diagnostics')     â† /monitoring/health/diagnostics
# @Get('applications')           â† /monitoring/applications
# âŒ ç¼ºå°‘ @Get('health/recent-events')

# 4. æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„ Service æ–¹æ³•
grep -r "getRecentEvents" src/modules/monitoring --include="*.service.ts"
# å¦‚æœæœ‰ â†’ Service æ–¹æ³•å­˜åœ¨ï¼Œåªæ˜¯ Controller æ²¡æœ‰æš´éœ²

# 5. æ£€æŸ¥ main.ts çš„å…¨å±€å‰ç¼€
cat src/main.ts | grep setGlobalPrefix
# app.setGlobalPrefix('api')
# æ‰€ä»¥å®Œæ•´è·¯å¾„æ˜¯ /api/monitoring/health/recent-events
```

#### è§£å†³æ–¹æ¡ˆï¼š

```typescript
// src/modules/monitoring/monitoring-health.controller.ts
// æ·»åŠ ç¼ºå¤±çš„ç«¯ç‚¹

@Get('health/recent-events')
@ApiOperation({ summary: 'è·å–æœ€è¿‘çš„ç›‘æ§äº‹ä»¶' })
async getRecentEvents(@Query('limit') limit?: string) {
    const parsedLimit = limit ? parseInt(limit) : 10
    return await this.monitoringHealthService.getRecentEvents(parsedLimit)
}
```

---

### Case 2: 400 Bad Request

**é”™è¯¯ä¿¡å·**ï¼š`expected 200 but got 400`ï¼Œé”™è¯¯æ¶ˆæ¯ï¼š`Invalid appId`

#### åˆ†ææ­¥éª¤ï¼š

```bash
# 1. æ‰¾åˆ°æµ‹è¯•ä½¿ç”¨çš„ appId
cat test/api.e2e.test.ts | grep "VALID_APP_ID"
# const VALID_APP_ID = 'vanillaV9pEeA'

# 2. æ‰¾åˆ° appId éªŒè¯é€»è¾‘
grep -r "validateAppId" src/modules --include="*.service.ts" -A 10
# æ‰¾åˆ° MonitoringService.validateAppId() æ–¹æ³•

cat src/modules/monitoring/monitoring.service.ts | grep -A 20 "validateAppId"
```

#### æŸ¥çœ‹éªŒè¯é€»è¾‘ï¼š

```typescript
async validateAppId(appId: string): Promise<boolean> {
    try {
        const app = await this.applicationRepository.findOne({
            where: { appId },
        })

        if (!app) {
            throw new BadRequestException(`Invalid appId: ${appId}...`)
        }
        // â†‘ è¿™é‡ŒæŠ›å‡º400é”™è¯¯
        
        return true
    }
}
```

#### é—®é¢˜å®šä½ï¼š

```bash
# æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰è¿™ä¸ª appId
docker exec -i sky-monitor-postgres psql -U postgres -d postgres -c \
  "SELECT * FROM application WHERE app_id = 'vanillaV9pEeA';"

# å¦‚æœæŸ¥è¯¢ç»“æœä¸ºç©º â†’ æµ‹è¯•æ•°æ®æœªåˆå§‹åŒ–
# è§£å†³ï¼šæ‰§è¡Œæµ‹è¯•æ•°æ®åˆå§‹åŒ–è„šæœ¬
```

---

### Case 3: 500 Internal Server Error

**é”™è¯¯ä¿¡å·**ï¼š`expected 200 but got 500`

#### åˆ†ææ­¥éª¤ï¼š

```bash
# 1. çœ‹æµ‹è¯•è®¿é—®çš„ç«¯ç‚¹
cat test/api.e2e.test.ts | grep -B2 -A3 "expected.*500"

# 2. æŸ¥çœ‹åç«¯è¯¥ç«¯ç‚¹çš„å®ç°
# å‡è®¾æ˜¯ GET /tracking
cat src/modules/version/version.controller.ts | grep -A5 "tracking"

# 3. æŸ¥çœ‹ Service å®ç°
cat src/modules/version/version.service.ts | grep -A20 "async tracking"
```

#### æŸ¥çœ‹å¯èƒ½å‡ºé”™çš„ä»£ç ï¼š

```typescript
async tracking(params: { event_type: string; message: string }) {
    const res = await this.clickhouseClient.insert({
        table: 'base_monitor_storage',  // â† è¿™ä¸ªè¡¨å¯èƒ½ä¸å­˜åœ¨
        values: params,
        columns: ['event_type', 'message'],
        format: 'JSONEachRow',
    })
}
```

#### é—®é¢˜å®šä½ï¼š

```bash
# æ£€æŸ¥ ClickHouse è¡¨æ˜¯å¦å­˜åœ¨
docker exec -i sky-monitor-clickhouse clickhouse-client --query \
  "SHOW TABLES LIKE 'base_monitor_storage';"

# å¦‚æœè¡¨ä¸å­˜åœ¨ï¼š
# é€‰é¡¹1ï¼šåˆ›å»ºè¡¨ï¼ˆå¦‚æœæ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼‰
# é€‰é¡¹2ï¼šåˆ é™¤æµ‹è¯•ï¼ˆå¦‚æœä¸æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼‰
```

---

## ğŸ”¬ æ·±å…¥åˆ†æï¼šä»£ç å±‚é¢å®šä½

### æ£€æŸ¥ç‚¹1ï¼šController å±‚

```bash
# æŸ¥çœ‹æ‰€æœ‰ Controller å®šä¹‰
find src/modules -name "*.controller.ts" -exec echo "=== {} ===" \; -exec cat {} \;

# å…³é”®æ£€æŸ¥ï¼š
# 1. @Controller() çš„è·¯å¾„å‚æ•°
# 2. @Get/@Post çš„è·¯å¾„
# 3. æ–¹æ³•å‚æ•° @Param/@Query/@Body æ˜¯å¦æ­£ç¡®
```

**ç¤ºä¾‹åˆ†æ**ï¼š

```typescript
// âœ… æ­£ç¡®
@Controller('monitoring')  // /api/monitoring
class MonitoringController {
    @Post(':appId')  // /api/monitoring/:appId
    async receiveEvent(@Param('appId') appId: string) {}
}

// âŒ é”™è¯¯ï¼šæµ‹è¯•æœŸæœ› /api/monitoring/health/recent-events
@Controller('monitoring')
class Controller {
    @Get('recent-events')  // âŒ å®é™…æ˜¯ /api/monitoring/recent-events
    // åº”è¯¥æ˜¯ @Get('health/recent-events')
}
```

### æ£€æŸ¥ç‚¹2ï¼šService å±‚

```bash
# æŸ¥çœ‹ Service çš„ä¾èµ–æ³¨å…¥
cat src/modules/monitoring/monitoring.service.ts | grep -E "constructor|@Inject"

# å…³é”®æ£€æŸ¥ï¼š
# 1. ClickHouseClient æ˜¯å¦æ­£ç¡®æ³¨å…¥
# 2. Repository æ˜¯å¦æ­£ç¡®æ³¨å…¥
# 3. Queue æ˜¯å¦æ­£ç¡®æ³¨å…¥
```

**ç¤ºä¾‹åˆ†æ**ï¼š

```typescript
constructor(
    @Inject('CLICKHOUSE_CLIENT') private clickhouseClient: ClickHouseClient,
    @InjectRepository(ApplicationEntity) private applicationRepository: Repository<ApplicationEntity>,
    @InjectQueue('sourcemap-parser') private parseQueue: Queue
) {}

// æ£€æŸ¥ç‚¹ï¼š
// 1. CLICKHOUSE_CLIENT æ˜¯å¦åœ¨ module ä¸­æä¾›ï¼Ÿ
// 2. ApplicationEntity æ˜¯å¦åœ¨ TypeOrmModule.forFeature ä¸­å¯¼å…¥ï¼Ÿ
// 3. sourcemap-parser é˜Ÿåˆ—æ˜¯å¦åœ¨ BullModule ä¸­æ³¨å†Œï¼Ÿ
```

### æ£€æŸ¥ç‚¹3ï¼šModule é…ç½®

```bash
# æŸ¥çœ‹ Module çš„ imports
cat src/modules/monitoring/monitoring.module.ts
```

**ç¤ºä¾‹åˆ†æ**ï¼š

```typescript
@Module({
    imports: [
        TypeOrmModule.forFeature([ApplicationEntity]),  // â† Repository ä¾èµ–
        BullModule.registerQueue({ name: 'sourcemap-parser' }),  // â† Queue ä¾èµ–
    ],
    controllers: [MonitoringController, MonitoringHealthController],
    providers: [MonitoringService, MonitoringHealthService],
})

// æ£€æŸ¥ç‚¹ï¼š
// 1. æ‰€æœ‰ä½¿ç”¨çš„ Entity æ˜¯å¦éƒ½åœ¨ forFeature ä¸­ï¼Ÿ
// 2. æ‰€æœ‰ä½¿ç”¨çš„ Queue æ˜¯å¦éƒ½æ³¨å†Œäº†ï¼Ÿ
// 3. Controller å’Œ Service æ˜¯å¦éƒ½å£°æ˜äº†ï¼Ÿ
```

### æ£€æŸ¥ç‚¹4ï¼šæ•°æ®åº“æ“ä½œ

```bash
# æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢
grep -r "findOne\|findAndCount\|insert\|query" src/modules/monitoring/*.service.ts -B2 -A5
```

**ç¤ºä¾‹åˆ†æ**ï¼š

```typescript
// æ£€æŸ¥ where æ¡ä»¶æ˜¯å¦æ­£ç¡®
const app = await this.applicationRepository.findOne({
    where: { appId },  // â† å­—æ®µåæ˜¯å¦æ­£ç¡®ï¼ŸEntity ä¸­æ˜¯ appId è¿˜æ˜¯ app_idï¼Ÿ
})

// æ£€æŸ¥ ClickHouse è¡¨åå’Œå­—æ®µ
await this.clickhouseClient.insert({
    table: 'monitor_events',  // â† è¡¨åæ˜¯å¦å­˜åœ¨ï¼Ÿ
    values: [eventData],
    format: 'JSONEachRow',
})
```

---

## ğŸª å®æˆ˜æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹ï¼šæµ‹è¯•æŠ¥é”™ "should retrieve recent events" 404

```bash
# ç¬¬1æ­¥ï¼šè¯»å–æµ‹è¯•ä»£ç 
cat test/api.e2e.test.ts | grep -A5 "should retrieve recent events"
```

è¾“å‡ºï¼š
```javascript
it('should retrieve recent events', async () => {
    const { status, data } = await client.get('/monitoring/health/recent-events?limit=5')
    expect(status).toBe(200)  // â† æœŸæœ› 200
})
```

```bash
# ç¬¬2æ­¥ï¼šæŸ¥æ‰¾åç«¯è·¯ç”±
grep -r "recent-events" src/modules --include="*.controller.ts"
```

è¾“å‡ºï¼š**ç©º** â†’ ç«¯ç‚¹ä¸å­˜åœ¨

```bash
# ç¬¬3æ­¥ï¼šæŸ¥æ‰¾æ˜¯å¦æœ‰å¯¹åº”çš„ Service æ–¹æ³•
grep -r "getRecentEvents" src/modules --include="*.service.ts" -A5
```

è¾“å‡ºï¼š
```typescript
// monitoring-health.service.ts
async getRecentEvents(limit: number = 10) {
    // ... å®ç°å­˜åœ¨
}
```

**ç»“è®º**ï¼šService æ–¹æ³•å­˜åœ¨ï¼Œä½† Controller æ²¡æœ‰æš´éœ²è¯¥ç«¯ç‚¹

**è§£å†³**ï¼šåœ¨ `monitoring-health.controller.ts` ä¸­æ·»åŠ ï¼š

```typescript
@Get('health/recent-events')
async getRecentEvents(@Query('limit') limit?: string) {
    const parsedLimit = limit ? parseInt(limit) : 10
    return await this.monitoringHealthService.getRecentEvents(parsedLimit)
}
```

---

## ğŸ’¡ å¿«é€Ÿå®šä½å‘½ä»¤åˆé›†

```bash
# 1. æ‰¾åˆ°æµ‹è¯•å¤±è´¥çš„ç«¯ç‚¹è·¯å¾„
grep -A3 "å¤±è´¥çš„æµ‹è¯•åç§°" test/api.e2e.test.ts

# 2. åœ¨ Controller ä¸­æœç´¢è¯¥è·¯å¾„
grep -r "ç«¯ç‚¹è·¯å¾„å…³é”®è¯" src/modules --include="*.controller.ts" -B2 -A5

# 3. æŸ¥çœ‹å®Œæ•´çš„ Controller è·¯ç”±ç»“æ„
cat src/modules/*/monitoring-*.controller.ts | grep -E "@Controller|@Get|@Post"

# 4. æœç´¢ç›¸å…³çš„ Service æ–¹æ³•
grep -r "æ–¹æ³•å" src/modules --include="*.service.ts" -A10

# 5. æ£€æŸ¥æ•°æ®åº“ç›¸å…³ä»£ç 
grep -r "validateAppId\|findOne\|insert" src/modules/*.service.ts -A5

# 6. æŸ¥çœ‹ Module çš„ä¾èµ–é…ç½®
cat src/modules/monitoring/monitoring.module.ts
```

---

## ğŸ§  æ€ç»´æµç¨‹å›¾

```
æµ‹è¯•å¤±è´¥ (404/400/500)
    â†“
è¯»å–é”™è¯¯ä¿¡æ¯ï¼ˆçŠ¶æ€ç  + ç«¯ç‚¹ + é”™è¯¯æ¶ˆæ¯ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 404: ç«¯ç‚¹ä¸å­˜åœ¨                      â”‚
â”‚  â†’ æœç´¢ Controller è·¯ç”±              â”‚
â”‚  â†’ æ£€æŸ¥ Service æ–¹æ³•æ˜¯å¦å­˜åœ¨          â”‚
â”‚  â†’ æ·»åŠ ç¼ºå¤±çš„è·¯ç”±æˆ–åˆ é™¤å¤šä½™çš„æµ‹è¯•      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 400: å‚æ•°éªŒè¯å¤±è´¥                    â”‚
â”‚  â†’ æŸ¥æ‰¾éªŒè¯é€»è¾‘ (validateAppId ç­‰)   â”‚
â”‚  â†’ æ£€æŸ¥æ•°æ®åº“æ•°æ®æ˜¯å¦å­˜åœ¨             â”‚
â”‚  â†’ åˆå§‹åŒ–æµ‹è¯•æ•°æ®æˆ–ä¿®æ­£éªŒè¯é€»è¾‘       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 500: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯                  â”‚
â”‚  â†’ æŸ¥çœ‹ Service å®ç°                 â”‚
â”‚  â†’ æ£€æŸ¥æ•°æ®åº“è¡¨/ä¾èµ–æ˜¯å¦å­˜åœ¨          â”‚
â”‚  â†’ ä¿®å¤ä¾èµ–æˆ–åˆ é™¤éæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

è¿™ä»½ debug æç¤ºè¯ä¸“æ³¨äº**ä»æµ‹è¯•é”™è¯¯åæ¨åç«¯ä»£ç é—®é¢˜**ï¼Œæ›´ç¬¦åˆä½ çš„éœ€æ±‚ï¼ğŸ¯